{"remainingRequest":"/Users/mdzz/Desktop/讲义/node_modules/_vue-loader@15.9.7@vue-loader/lib/index.js??vue-loader-options!/Users/mdzz/Desktop/讲义/src/components/ClipImage.vue?vue&type=style&index=0&id=f63c9b2a&lang=less&scoped=true&","dependencies":[{"path":"/Users/mdzz/Desktop/讲义/src/components/ClipImage.vue","mtime":1621007407998},{"path":"/Users/mdzz/Desktop/讲义/node_modules/_css-loader@3.6.0@css-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/mdzz/Desktop/讲义/node_modules/_vue-loader@15.9.7@vue-loader/lib/loaders/stylePostLoader.js","mtime":499162500000},{"path":"/Users/mdzz/Desktop/讲义/node_modules/_postcss-loader@3.0.0@postcss-loader/src/index.js","mtime":499162500000},{"path":"/Users/mdzz/Desktop/讲义/node_modules/_less-loader@5.0.0@less-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/mdzz/Desktop/讲义/node_modules/_cache-loader@4.1.0@cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/mdzz/Desktop/讲义/node_modules/_vue-loader@15.9.7@vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoNCi5jbGlwSW1hZ2VCb3ggew0KICBwYWRkaW5nOiAwLjJyZW07DQp9DQoNCi5jbGlwSW1hZ2VCb3ggLmNhbnZhc0JveCB7DQogIHBvc2l0aW9uOiByZWxhdGl2ZTsNCiAgb3ZlcmZsb3c6IGhpZGRlbjsNCn0NCg0KLmNsaXBJbWFnZUJveCAuY2FudmFzQm94IGNhbnZhcyB7DQogIGRpc3BsYXk6IGJsb2NrOw0KICBib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICBtYXJnaW46IDAgYXV0bzsNCiAgd2lkdGg6IDcuMXJlbTsNCiAgaGVpZ2h0OiA3LjFyZW07DQogIGJvcmRlcjogMC4wMnJlbSBzb2xpZCAjZGRkOw0KfQ0KDQouY2xpcEltYWdlQm94IC5jYW52YXNCb3ggLm1hcmsgew0KICBib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICBwb3NpdGlvbjogYWJzb2x1dGU7DQogIHotaW5kZXg6IDIwOw0KICB3aWR0aDogNzAlOw0KICBoZWlnaHQ6IDcwJTsNCiAgYm9yZGVyOiAwLjAycmVtIGRhc2hlZCBsaWdodGNvcmFsOw0KICBiYWNrZ3JvdW5kOiByZ2JhKDAsIDAsIDAsIDAuMik7DQp9DQoNCi5jbGlwSW1hZ2VCb3ggLmJ1dHRvbkJveCAuZmlsZSB7DQogIGRpc3BsYXk6IG5vbmU7DQp9DQoNCi5jbGlwSW1hZ2VCb3ggLmJ1dHRvbkJveCB7DQogIG1hcmdpbi10b3A6IDAuM3JlbTsNCn0NCg0KLmNsaXBJbWFnZUJveCAuYnV0dG9uQm94IGJ1dHRvbiB7DQogIG1hcmdpbi1yaWdodDogMC4ycmVtOw0KICBwYWRkaW5nOiAwLjJyZW07DQogIGJvcmRlcjogbm9uZTsNCiAgZm9udC1zaXplOiAwLjI4cmVtOw0KICBiYWNrZ3JvdW5kOiBsaWdodGJsdWU7DQogIGN1cnNvcjogcG9pbnRlcjsNCn0NCg=="},{"version":3,"sources":["ClipImage.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqKA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"ClipImage.vue","sourceRoot":"src/components","sourcesContent":["<template>\r\n  <div class=\"clipImageBox\">\r\n    <div class=\"canvasBox\" @touchstart=\"startFunc\" @touchmove=\"moveFunc\">\r\n      <canvas :width=\"CW\" :height=\"CH\" ref=\"canvas\"></canvas>\r\n      <div\r\n        class=\"mark\"\r\n        v-show=\"ISMARK\"\r\n        :style=\"{\r\n          width: MW + 'px',\r\n          height: MH + 'px',\r\n          left: ML + 'px',\r\n          top: MT + 'px',\r\n        }\"\r\n      ></div>\r\n    </div>\r\n\r\n    <div class=\"buttonBox\">\r\n      <input type=\"file\" class=\"file\" ref=\"file\" @change=\"changFunc\" />\r\n      <button @click=\"clickFunc\">选择图片</button>\r\n      <button @click=\"scaleFunc(1)\">放大</button>\r\n      <button @click=\"scaleFunc(0)\">缩小</button>\r\n      <button @click=\"saveFunc\">保存图片</button>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    let winW = document.documentElement.clientWidth,\r\n      font = parseFloat(document.documentElement.style.fontSize),\r\n      canvasW = winW - 0.4 * font,\r\n      markW = canvasW * 0.7;\r\n    return {\r\n      // 画布大小\r\n      CW: canvasW,\r\n      CH: canvasW,\r\n      // MARK大小和位置\r\n      MW: markW,\r\n      MH: markW,\r\n      ML: (canvasW - markW) / 2,\r\n      MT: (canvasW - markW) / 2,\r\n      // 上传图片的大小和位置\r\n      IW: 0,\r\n      IH: 0,\r\n      IL: 0,\r\n      IT: 0,\r\n      // 是否显示MARK\r\n      ISMARK: false,\r\n    };\r\n  },\r\n  methods: {\r\n    clickFunc() {\r\n      // 触发file选择文件操作\r\n      this.$refs.file.click(); //直接触发input的点击事件\r\n    },\r\n    changFunc() {\r\n      // 已经选择了图片\r\n      this.ISMARK = true;\r\n      console.dir(this.$refs.file); // 文件信息\r\n      let file = this.$refs.file.files[0];\r\n      if (!file) return; //点击取消 没有选择就不往下走\r\n      // 先基于FileReader进行文件读取\r\n      let fileExample = new FileReader();\r\n      fileExample.readAsDataURL(file); // 读成base64\r\n      // 读取完成触发\r\n      fileExample.onload = (e) => {\r\n        // e.target.result  base64码\r\n        //创建新图片\r\n        this.IMAGE = new Image();\r\n        this.IMAGE.src = e.target.result;\r\n        this.IMAGE.onload = () => {\r\n          // 给图片设置宽高/位置\r\n          this.IW = this.IMAGE.width;\r\n          this.IH = this.IMAGE.height;\r\n          // 重新按照比列计算宽高 图片很宽 让宽和画布保持一致 高等比缩放，图片很高 让高和画布保持一致 宽等比缩放，\r\n          let n = 1; // 缩放比\r\n          if (this.IW > this.IH) {\r\n            n = this.CW / this.IW;\r\n            this.IW = this.CW;\r\n            this.IH = this.IH * n;\r\n          } else {\r\n            n = this.CH / this.IH;\r\n            this.IH = this.CH;\r\n            this.IW = this.IW * n;\r\n          }\r\n\r\n          this.IL = (this.CW - this.IW) / 2;\r\n          this.IT = (this.CH - this.IH) / 2;\r\n          this.drawImage();\r\n        };\r\n      };\r\n    },\r\n    // 在canvas中绘制图片\r\n    drawImage() {\r\n      this.CTX = this.$refs.canvas.getContext(\"2d\");\r\n      this.CTX.clearRect(0, 0, this.CW, this.CH); //清空画布\r\n      // 绘制图片  需要绘制的图片,图片位置，图片宽高\r\n      this.CTX.drawImage(this.IMAGE, this.IL, this.IT, this.IW, this.IH);\r\n    },\r\n    // 缩放图片\r\n    scaleFunc(flag) {\r\n      if (!this.IMAGE) return;\r\n      // 按照图片宽高比进行缩放\r\n      let n = this.IW / this.IH,\r\n        n1 = 20,\r\n        n2 = n1 / n;\r\n      if (flag) {\r\n        this.IW += n1;\r\n        this.IH += n2;\r\n      } else {\r\n        this.IW -= n1;\r\n        this.IH -= n2;\r\n      }\r\n      this.drawImage();\r\n    },\r\n    startFunc(e) {\r\n      // 按下的时候记录手指的坐标\r\n      if (!this.IMAGE) return;\r\n      let point = e.changedTouches[0];\r\n      this.startX = point.clientX;\r\n      this.startY = point.clientY;\r\n    },\r\n    //移动遮罩层\r\n    moveFunc(e) {\r\n      if (!this.IMAGE) return;\r\n      let point = e.changedTouches[0];\r\n      this.changeX = point.clientX - this.startX;\r\n      this.changeY = point.clientY - this.startY;\r\n      // 防止手指抖动 误操作 \r\n      if (Math.abs(this.changeX) > 10 || Math.abs(this.changeY) > 10) {\r\n        this.IL += this.changeX;\r\n        this.IT += this.changeY;\r\n        this.drawImage();\r\n        this.startX = point.clientX;\r\n        this.startY = point.clientY;\r\n      }\r\n    },\r\n    saveFunc() {\r\n      if (!this.IMAGE) return;\r\n      // 获取指定区域的像素信息 即遮罩层的覆盖的区域\r\n      let imageData = this.CTX.getImageData(this.ML, this.MT, this.MW, this.MH);\r\n      // 创建新的画布 不需要往页面中\r\n      let canvas2 = document.createElement(\"canvas\"),\r\n        canvas2CTX = canvas2.getContext(\"2d\");\r\n      canvas2.width = this.MW;\r\n      canvas2.height = this.MH;\r\n      // 把像素信息放置到画布中\r\n      canvas2CTX.putImageData(imageData, 0, 0, 0, 0, this.MW, this.MH);\r\n      // 把画布中的内容生成图片的BASE64\r\n      this.$emit(\"saveImage\", canvas2.toDataURL(\"image/png\"));\r\n    },\r\n  },\r\n};\r\n\r\n/*\r\n *  1. 我们需要准备一些数据：画布的大小、MARK遮罩层的大小和位置、上传图片的大小和位置、是否显示MARK...\r\n *  2. 上传图片：选中图片，把其绘制到画布中\r\n *  3. 实现图片的拖拽Touch：重新绘制图片所在的位置\r\n *  4. 实现如图的方法和缩小：重新绘制图片的大小\r\n *  5. 保存图片的时候：把遮罩层选中的部分（像素）最后生成一张新的图片\r\n */\r\n</script>\r\n\r\n<style lang=\"less\" scoped>\r\n.clipImageBox {\r\n  padding: 0.2rem;\r\n}\r\n\r\n.clipImageBox .canvasBox {\r\n  position: relative;\r\n  overflow: hidden;\r\n}\r\n\r\n.clipImageBox .canvasBox canvas {\r\n  display: block;\r\n  box-sizing: border-box;\r\n  margin: 0 auto;\r\n  width: 7.1rem;\r\n  height: 7.1rem;\r\n  border: 0.02rem solid #ddd;\r\n}\r\n\r\n.clipImageBox .canvasBox .mark {\r\n  box-sizing: border-box;\r\n  position: absolute;\r\n  z-index: 20;\r\n  width: 70%;\r\n  height: 70%;\r\n  border: 0.02rem dashed lightcoral;\r\n  background: rgba(0, 0, 0, 0.2);\r\n}\r\n\r\n.clipImageBox .buttonBox .file {\r\n  display: none;\r\n}\r\n\r\n.clipImageBox .buttonBox {\r\n  margin-top: 0.3rem;\r\n}\r\n\r\n.clipImageBox .buttonBox button {\r\n  margin-right: 0.2rem;\r\n  padding: 0.2rem;\r\n  border: none;\r\n  font-size: 0.28rem;\r\n  background: lightblue;\r\n  cursor: pointer;\r\n}\r\n</style>"]}]}